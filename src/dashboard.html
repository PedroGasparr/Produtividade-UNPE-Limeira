<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processo de Carregamento - Sistema PA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/dahboard.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <button class="hamburger-btn" id="hamburgerBtn">
            <i class="fas fa-bars"></i>
        </button>
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="../img/GZL - Logos_pages-to-jpg-0001.jpg" alt="Logo PA" class="sidebar-logo">
                <h2>Sistema PA</h2>
            </div>
            <ul class="sidebar-menu">
                <li class="active"><a href="dashboard.html"><i class="fas fa-home"></i> Início</a></li>
                <li><a href="dash.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="cadastro_colaborador.html"><i class="fas fa-users"></i> Cadastrar Funcionários</a></li>
                <li><a href="buscar_funcionarios.html"><i class="fas fa-search"></i> Buscar Funcionários</a></li>
                <li><a href="painel_de_controle.html"><i class="fa fa-tasks"></i> Painel De Controle</a></li>
                <li><a href="historico.html"><i class="fas fa-history"></i> Histórico</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <h1>Processo de Carregamento</h1>
                <div class="user-info">
                    <span id="currentUser">Usuário Logado</span>
                </div>
            </header>

            <!-- Process Cards Container -->
            <div id="processCardsContainer" class="process-cards">
                <!-- Cards will be dynamically inserted here -->
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" id="mainActionButtons">
                <button class="btn primary-btn" id="startShipmentProcessBtn">
                    <i class="fas fa-plus"></i> Novo Processo
                </button>
            </div>

            <!-- Modal Iniciar Processo -->
            <div class="modal" id="startProcessModal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2>Iniciar Novo Processo</h2>

                    <div id="startProcessFeedback" class="feedback"></div>

                    <div class="form-group">
                        <label for="dtNumber">Número da DT:</label>
                        <input type="text" id="dtNumber" placeholder="Digite o número da DT" required>
                    </div>

                    <div class="form-group">
                        <label for="vehicleType">Tipo de Processo:</label>
                        <select id="vehicleType" required>
                            <option value="">Selecione...</option>
                            <option value="carregamento">Carregamento</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="dockNumber">Número da Doca:</label>
                        <select id="dockNumber" required>
                            <option value="">Selecione...</option>
                            <option value="1">Doca 1</option>
                            <option value="2">Doca 2</option>
                            <option value="3">Doca 3</option>
                            <option value="4">Doca 4</option>
                            <option value="5">Doca 5</option>
                            <option value="6">Doca 6</option>
                            <option value="7">Doca 7</option>
                            <option value="8">Doca 8</option>
                            <option value="9">Doca 9</option>
                            <option value="10">Doca 10</option>
                            <option value="11">Doca 11</option>
                            <option value="12">Doca 12</option>
                            <option value="13">Doca 13</option>
                            <option value="14">Doca 14</option>
                            <option value="15">Doca 15</option>
                        </select>
                    </div>

                    <div class="modal-actions">
                        <button class="btn secondary-btn" id="cancelStartProcessBtn">Cancelar</button>
                        <button class="btn primary-btn" id="confirmStartProcessBtn">Iniciar Processo</button>
                    </div>
                </div>
            </div>

            <!-- Modal QR Code Genérico -->
            <div class="modal" id="qrCodeModal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2 id="qrCodeModalTitle">Ler QR Code</h2>

                    <div id="qrCodeFeedback" class="feedback"></div>

                    <div class="qr-scanner-container">
                        <video id="qrCodeScanner" width="100%" playsinline></video>
                        <button class="btn primary-btn" id="startQrCodeScannerBtn">
                            <i class="fas fa-qrcode"></i> Ativar Leitor QR Code
                        </button>
                    </div>

                    <div id="qrCodeOperatorInfo" style="display: none; margin: 10px 0;">
                        Operador: <strong id="qrCodeOperatorName"></strong>
                    </div>

                    <div class="modal-actions">
                        <button class="btn secondary-btn" id="cancelQrCodeBtn">Cancelar</button>
                        <button class="btn primary-btn" id="confirmQrCodeBtn" disabled>Confirmar</button>
                    </div>
                </div>
            </div>

            <!-- Modal Múltiplos Ajudantes -->
            <div class="modal" id="assistantsModal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2 id="assistantsModalTitle">Registrar Ajudantes</h2>

                    <div id="assistantsFeedback" class="feedback"></div>

                    <div class="qr-scanner-container">
                        <video id="assistantsScanner" width="100%" playsinline></video>
                        <button class="btn primary-btn" id="startAssistantsScannerBtn">
                            <i class="fas fa-qrcode"></i> Adicionar Ajudante
                        </button>
                    </div>

                    <div class="step-assistants" id="assistantsList">
                        <!-- Ajudantes serão listados aqui -->
                    </div>

                    <div class="modal-actions">
                        <button class="btn secondary-btn" id="cancelAssistantsBtn">Cancelar</button>
                        <button class="btn primary-btn" id="confirmAssistantsBtn">Confirmar</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="../js/hamb.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBLihrR113eqHsAuZLCnuMaNoGat7I8i88",
            authDomain: "produtividade-unpe-limeira.firebaseapp.com",
            projectId: "produtividade-unpe-limeira",
            storageBucket: "produtividade-unpe-limeira.firebasestorage.app",
            messagingSenderId: "1073200439869",
            appId: "1:1073200439869:web:2616ac068ee7488c21c054",
            measurementId: "G-B9QGYWE6D9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Variáveis globais
        let currentUser = null;
        let currentScanner = null;
        let processes = {};
        let timers = {};
        let pauseTimers = {};
        let currentAssistants = [];
        let lastUpdate = 0;

        // Elementos da página
        const elements = {
            startShipmentProcessBtn: document.getElementById('startShipmentProcessBtn'),
            currentUser: document.getElementById('currentUser'),
            mainActionButtons: document.getElementById('mainActionButtons'),
            processCardsContainer: document.getElementById('processCardsContainer'),
            
            // Modals
            startProcessModal: document.getElementById('startProcessModal'),
            qrCodeModal: document.getElementById('qrCodeModal'),
            assistantsModal: document.getElementById('assistantsModal'),
            
            // Start Process Modal
            dtNumber: document.getElementById('dtNumber'),
            vehicleType: document.getElementById('vehicleType'),
            dockNumber: document.getElementById('dockNumber'),
            confirmStartProcessBtn: document.getElementById('confirmStartProcessBtn'),
            cancelStartProcessBtn: document.getElementById('cancelStartProcessBtn'),
            startProcessFeedback: document.getElementById('startProcessFeedback'),
            
            // QR Code Modal
            qrCodeModalTitle: document.getElementById('qrCodeModalTitle'),
            qrCodeScanner: document.getElementById('qrCodeScanner'),
            startQrCodeScannerBtn: document.getElementById('startQrCodeScannerBtn'),
            qrCodeOperatorName: document.getElementById('qrCodeOperatorName'),
            qrCodeOperatorInfo: document.getElementById('qrCodeOperatorInfo'),
            confirmQrCodeBtn: document.getElementById('confirmQrCodeBtn'),
            cancelQrCodeBtn: document.getElementById('cancelQrCodeBtn'),
            qrCodeFeedback: document.getElementById('qrCodeFeedback'),
            
            // Assistants Modal
            assistantsModalTitle: document.getElementById('assistantsModalTitle'),
            assistantsScanner: document.getElementById('assistantsScanner'),
            startAssistantsScannerBtn: document.getElementById('startAssistantsScannerBtn'),
            assistantsList: document.getElementById('assistantsList'),
            confirmAssistantsBtn: document.getElementById('confirmAssistantsBtn'),
            cancelAssistantsBtn: document.getElementById('cancelAssistantsBtn'),
            assistantsFeedback: document.getElementById('assistantsFeedback'),
            
            // Others
            logoutBtn: document.getElementById('logoutBtn')
        };

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', () => {
            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    currentUser = user;
                    elements.currentUser.textContent = user.displayName || user.email;
                    setupEventListeners();
                    loadActiveProcesses();
                }
            });
        });

        function setupEventListeners() {
            elements.startShipmentProcessBtn.addEventListener('click', () => {
                elements.startProcessModal.style.display = 'flex';
            });
            
            elements.cancelStartProcessBtn.addEventListener('click', () => {
                elements.startProcessModal.style.display = 'none';
            });
            elements.confirmStartProcessBtn.addEventListener('click', startNewProcess);
            
            elements.startQrCodeScannerBtn.addEventListener('click', () => startScanner('generic'));
            elements.cancelQrCodeBtn.addEventListener('click', () => {
                elements.qrCodeModal.style.display = 'none';
                stopScanner();
            });
            elements.confirmQrCodeBtn.addEventListener('click', confirmCurrentStep);
            
            elements.startAssistantsScannerBtn.addEventListener('click', () => startScanner('assistants'));
            elements.cancelAssistantsBtn.addEventListener('click', () => {
                elements.assistantsModal.style.display = 'none';
                stopScanner();
                currentAssistants = [];
            });
            elements.confirmAssistantsBtn.addEventListener('click', confirmAssistants);
            
            elements.logoutBtn.addEventListener('click', () => {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
            
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                    stopScanner();
                    currentAssistants = [];
                });
            });
        }

        function loadActiveProcesses() {
            db.ref('processos').on('value', snapshot => {
                processes = {};
                if (snapshot.exists()) {
                    snapshot.forEach(processSnapshot => {
                        const processData = processSnapshot.val();
                        if (processData.status !== 'completed') {
                            processes[processSnapshot.key] = {
                                ...processData,
                                id: processSnapshot.key
                            };
                            
                            if (processData.status === 'in_progress' && !timers[processSnapshot.key]) {
                                const pauseTime = processData.totalPauseTime || 0;
                                startProcessTimer(processSnapshot.key, processData.startTime || Date.now(), pauseTime);
                            } else if (processData.status === 'paused' && !pauseTimers[processSnapshot.key]) {
                                const pauseTimerElement = document.getElementById(`pause-timer-${processSnapshot.key}`);
                                if (pauseTimerElement) {
                                    pauseTimerElement.style.display = 'block';
                                    const totalPauseTime = processData.totalPauseTime || 0;
                                    const currentPauseTime = processData.pauseStartTime ? 
                                        Math.floor((Date.now() - processData.pauseStartTime) / 1000) : 0;
                                    pauseTimerElement.textContent = formatTime(totalPauseTime + currentPauseTime);
                                }
                            }
                        }
                    });
                }
                renderProcessCards();
            });
        }

        function updatePauseTimers() {
            Object.keys(processes).forEach(processId => {
                const process = processes[processId];
                if (process.status === 'paused') {
                    const pauseTimerElement = document.getElementById(`pause-timer-${processId}`);
                    if (pauseTimerElement) {
                        const totalPauseTime = process.totalPauseTime || 0;
                        const currentPauseTime = process.pauseStartTime ? 
                            Math.floor((Date.now() - process.pauseStartTime) / 1000) : 0;
                        pauseTimerElement.textContent = formatTime(totalPauseTime + currentPauseTime);
                    }
                }
            });
        }

        function updateAllTimers() {
            Object.keys(processes).forEach(processId => {
                const process = processes[processId];
                if (process.status === 'in_progress') {
                    const timerElement = document.getElementById(`timer-${processId}`);
                    if (timerElement) {
                        const elapsed = Math.floor((Date.now() - process.startTime) / 1000) - (process.totalPauseTime || 0);
                        timerElement.textContent = formatTime(elapsed);
                    }
                }
            });
        }

        function renderProcessCards() {
            elements.processCardsContainer.innerHTML = '';
            
            if (Object.keys(processes).length === 0) {
                showNoProcessesMessage();
                return;
            }
            
            Object.values(processes).forEach(process => {
                const card = createProcessCard(process);
                elements.processCardsContainer.appendChild(card);
            });
        }

        function efficientUpdate() {
            const now = Date.now();
            if (now - lastUpdate > 500) {
                updateAllTimers();
                updatePauseTimers();
                lastUpdate = now;
            }
            requestAnimationFrame(efficientUpdate);
        }

        efficientUpdate();

        function createProcessCard(process) {
            const card = document.createElement('div');
            card.className = 'process-card';
            card.dataset.processId = process.id;
            
            const header = document.createElement('div');
            header.className = 'process-card-header';
            
            const title = document.createElement('h3');
            title.className = 'process-card-title';
            title.textContent = `DT: ${process.dtNumber}`;
            
            const status = document.createElement('span');
            status.className = `process-card-status ${process.status}`;
            status.textContent = getStatusLabel(process.status);
            
            header.appendChild(title);
            header.appendChild(status);
            
            const body = document.createElement('div');
            body.className = 'process-card-body';
            
            const vehicleInfo = document.createElement('div');
            vehicleInfo.className = 'process-card-info';
            vehicleInfo.textContent = `Tipo: ${getProcessTypeLabel(process.vehicleType)}`;
            
            const dockInfo = document.createElement('div');
            dockInfo.className = 'process-card-info';
            dockInfo.textContent = `Doca: ${process.dockNumber}`;
            
            const timer = document.createElement('div');
            timer.className = 'timer-display';
            timer.innerHTML = `Tempo: <span id="timer-${process.id}">00:00:00</span>`;
            
            const pauseTimeDisplay = document.createElement('div');
            pauseTimeDisplay.className = 'pause-time';
            pauseTimeDisplay.innerHTML = `Pausa: <span id="pause-timer-${process.id}">00:00:00</span>`;
            pauseTimeDisplay.style.display = process.status === 'paused' ? 'block' : 'none';
            
            const currentStep = document.createElement('div');
            currentStep.className = 'step-title';
            currentStep.textContent = process.currentStep ? 
                getStepName(process.currentStep) : 'Processo concluído';
            
            const actions = document.createElement('div');
            actions.className = 'process-card-actions';
            
            if (process.status !== 'completed') {
                const pauseBtn = document.createElement('button');
                pauseBtn.className = process.status === 'paused' ? 'btn success-btn' : 'btn warning-btn';
                pauseBtn.innerHTML = process.status === 'paused' ? 
                    '<i class="fas fa-play"></i> Continuar' : 
                    '<i class="fas fa-pause"></i> Pausar';
                pauseBtn.addEventListener('click', () => togglePauseProcess(process.id));
                actions.appendChild(pauseBtn);
            }
            
            const stepButtonsContainer = document.createElement('div');
            stepButtonsContainer.className = 'step-buttons';
            
            if (process.status !== 'completed') {
                addStepButtons(stepButtonsContainer, process);
            }
            
            actions.appendChild(stepButtonsContainer);
            
            if (process.status !== 'completed') {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn danger-btn';
                cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
                cancelBtn.addEventListener('click', () => cancelProcess(process.id));
                actions.appendChild(cancelBtn);
            }
            
            body.appendChild(vehicleInfo);
            body.appendChild(dockInfo);
            body.appendChild(timer);
            body.appendChild(pauseTimeDisplay);
            body.appendChild(currentStep);
            body.appendChild(actions);
            
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }

        function togglePauseProcess(processId) {
            const process = processes[processId];
            if (!process) return;

            const processRef = db.ref(`processos/${processId}`);
            const now = Date.now();
            const updates = {};

            if (process.status === 'paused') {
                updates.status = 'in_progress';
                updates.resumeTime = now;
                
                if (process.pauseStartTime) {
                    const pauseDuration = (now - process.pauseStartTime) / 1000;
                    updates.totalPauseTime = (process.totalPauseTime || 0) + pauseDuration;
                }
                
                processRef.update(updates)
                    .then(() => {
                        startProcessTimer(processId, process.startTime, updates.totalPauseTime || process.totalPauseTime || 0);
                        if (pauseTimers[processId]) {
                            clearInterval(pauseTimers[processId]);
                            delete pauseTimers[processId];
                        }
                        
                        const pauseTimerElement = document.getElementById(`pause-timer-${processId}`);
                        if (pauseTimerElement) {
                            pauseTimerElement.style.display = 'none';
                        }
                    });
            } else {
                updates.status = 'paused';
                updates.pauseStartTime = now;
                
                processRef.update(updates)
                    .then(() => {
                        if (timers[processId]) {
                            clearInterval(timers[processId]);
                            delete timers[processId];
                        }
                        
                        const pauseTimerElement = document.getElementById(`pause-timer-${processId}`);
                        if (pauseTimerElement) {
                            pauseTimerElement.style.display = 'block';
                            
                            const totalPauseTime = process.totalPauseTime || 0;
                            let currentPauseSeconds = 0;
                            
                            pauseTimers[processId] = setInterval(() => {
                                currentPauseSeconds++;
                                pauseTimerElement.textContent = formatTime(totalPauseTime + currentPauseSeconds);
                            }, 1000);
                        }
                    });
            }
        }

        function startProcessTimer(processId, startTime, initialPauseTime = 0) {
            if (timers[processId]) clearInterval(timers[processId]);
            
            const timerElement = document.getElementById(`timer-${processId}`);
            const pauseTimerElement = document.getElementById(`pause-timer-${processId}`);
            
            if (pauseTimerElement) {
                pauseTimerElement.style.display = 'none';
                pauseTimerElement.textContent = formatTime(initialPauseTime);
            }
            
            const updateTimer = () => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000) - initialPauseTime;
                if (timerElement) {
                    timerElement.textContent = formatTime(elapsed);
                }
            };
            
            updateTimer();
            timers[processId] = setInterval(updateTimer, 1000);
        }

        function addStepButtons(container, process) {
            const stepsOrder = getStepsOrder(process.vehicleType);
            const currentStepIndex = process.currentStep ? stepsOrder.indexOf(process.currentStep) : -1;
            
            if (currentStepIndex === -1) {
                const startBtn = document.createElement('button');
                startBtn.className = 'btn primary-btn';
                startBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar Vistoria';
                startBtn.addEventListener('click', () => showQrCodeModal('Iniciar Vistoria', 'start', process.id, 'vistoria'));
                container.appendChild(startBtn);
            } else {
                const currentStep = stepsOrder[currentStepIndex];
                const stepData = process[currentStep];
                
                if (stepData && stepData.status === 'in_progress') {
                    const endBtn = document.createElement('button');
                    endBtn.className = 'btn primary-btn';
                    endBtn.innerHTML = '<i class="fas fa-stop"></i> Finalizar Etapa';
                    
                    if (currentStep === 'abertura' || currentStep === 'fechamento') {
                        endBtn.addEventListener('click', () => showQrCodeModal(`Finalizar ${getStepName(currentStep)}`, 'complete', process.id, currentStep, true));
                    } else {
                        endBtn.addEventListener('click', () => showQrCodeModal(`Finalizar ${getStepName(currentStep)}`, 'complete', process.id, currentStep));
                    }
                    
                    container.appendChild(endBtn);
                    
                    if (currentStep === 'abertura' || currentStep === 'fechamento') {
                        const addBtn = document.createElement('button');
                        addBtn.className = 'btn secondary-btn';
                        addBtn.innerHTML = '<i class="fas fa-user-plus"></i> Adicionar Ajudantes';
                        addBtn.addEventListener('click', () => showAssistantsModal(process.id, currentStep));
                        container.appendChild(addBtn);
                    }
                } else {
                    const startBtn = document.createElement('button');
                    startBtn.className = 'btn primary-btn';
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar Etapa';
                    
                    if (currentStep === 'abertura' || currentStep === 'fechamento') {
                        startBtn.addEventListener('click', () => showAssistantsModal(process.id, currentStep, true));
                    } else {
                        startBtn.addEventListener('click', () => showQrCodeModal(`Iniciar ${getStepName(currentStep)}`, 'start', process.id, currentStep));
                    }
                    
                    container.appendChild(startBtn);
                }
            }
        }

        function showNoProcessesMessage() {
            const message = document.createElement('div');
            message.className = 'feedback info';
            message.textContent = 'Nenhum processo ativo encontrado. Clique em "Novo Processo" para começar.';
            elements.processCardsContainer.appendChild(message);
        }

        function showQrCodeModal(title, action, processId, step, isFinalStep = false) {
            elements.qrCodeModalTitle.textContent = title;
            elements.qrCodeModal.dataset.action = action;
            elements.qrCodeModal.dataset.processId = processId;
            elements.qrCodeModal.dataset.step = step;
            elements.qrCodeModal.dataset.isFinalStep = isFinalStep;
            
            elements.qrCodeOperatorName.textContent = '';
            elements.qrCodeOperatorInfo.style.display = 'none';
            elements.confirmQrCodeBtn.disabled = true;
            elements.qrCodeFeedback.style.display = 'none';
            
            elements.qrCodeModal.style.display = 'flex';
        }

        function showAssistantsModal(processId, step, isInitialStep = false) {
            elements.assistantsModalTitle.textContent = `Ajudantes para ${getStepName(step)}`;
            elements.assistantsModal.dataset.processId = processId;
            elements.assistantsModal.dataset.step = step;
            elements.assistantsModal.dataset.isInitialStep = isInitialStep;
            
            elements.assistantsList.innerHTML = '';
            elements.assistantsFeedback.style.display = 'none';
            currentAssistants = [];
            
            elements.assistantsModal.style.display = 'flex';
        }

        function startScanner(type) {
            stopScanner();
            
            let scannerElement = type === 'assistants' ? elements.assistantsScanner : elements.qrCodeScanner;
            scannerElement.style.display = 'block';
            
            currentScanner = new Instascan.Scanner({
                video: scannerElement,
                mirror: false
            });
            
            currentScanner.addListener('scan', content => handleQrScan(content, type));
            
            Instascan.Camera.getCameras()
                .then(cameras => {
                    if (cameras.length === 0) throw new Error('Nenhuma câmera encontrada');
                    const rearCamera = cameras.find(c => c.name.includes('traseira')) || 
                                     cameras.find(c => c.facing === 'environment') || 
                                     cameras[cameras.length - 1];
                    return currentScanner.start(rearCamera);
                })
                .catch(error => {
                    console.error('Erro ao iniciar scanner:', error);
                    showFeedback('Erro ao acessar câmera: ' + error.message, 'error', 
                               type === 'assistants' ? 'assistantsFeedback' : 'qrCodeFeedback');
                });
        }

        function stopScanner() {
            if (currentScanner) {
                currentScanner.stop();
                currentScanner = null;
            }
            elements.qrCodeScanner.style.display = 'none';
            elements.assistantsScanner.style.display = 'none';
        }

        function handleQrScan(content, type) {
            const qrCodeRegex = /^GZL-EO-\d{5}$/;
            if (!qrCodeRegex.test(content)) {
                showFeedback('QR Code inválido! Formato deve ser GZL-EO-XXXXX', 'error', 
                           type === 'assistants' ? 'assistantsFeedback' : 'qrCodeFeedback');
                return;
            }

            showFeedback('Validando QR Code...', 'info', 
                       type === 'assistants' ? 'assistantsFeedback' : 'qrCodeFeedback');

            db.ref('funcionarios').orderByChild('codigo').equalTo(content).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) throw new Error('Funcionário não encontrado');

                    let employeeData = null;
                    snapshot.forEach(child => {
                        employeeData = child.val();
                        return true;
                    });

                    if (type === 'assistants') {
                        if (!currentAssistants.some(a => a.code === content)) {
                            currentAssistants.push({
                                code: content,
                                name: employeeData.nome
                            });
                            updateAssistantsList();
                            showFeedback('Ajudante adicionado com sucesso!', 'success', 'assistantsFeedback');
                        } else {
                            showFeedback('Este ajudante já foi adicionado', 'warning', 'assistantsFeedback');
                        }
                    } else {
                        elements.qrCodeOperatorName.textContent = employeeData.nome;
                        elements.qrCodeOperatorInfo.style.display = 'block';
                        elements.confirmQrCodeBtn.disabled = false;
                        showFeedback('Operador validado com sucesso!', 'success', 'qrCodeFeedback');
                        stopScanner();
                    }
                })
                .catch(error => {
                    console.error('Erro ao validar QR Code:', error);
                    showFeedback('Erro: ' + error.message, 'error', 
                               type === 'assistants' ? 'assistantsFeedback' : 'qrCodeFeedback');
                });
        }

        function updateAssistantsList() {
            elements.assistantsList.innerHTML = '';
            currentAssistants.forEach(assistant => {
                const tag = document.createElement('span');
                tag.className = 'assistant-tag';
                tag.textContent = assistant.name;
                elements.assistantsList.appendChild(tag);
            });
        }

        function startNewProcess() {
            const dtNumber = elements.dtNumber.value.trim();
            const vehicleType = elements.vehicleType.value;
            const dockNumber = elements.dockNumber.value;

            if (!dtNumber || !vehicleType || !dockNumber) {
                showFeedback('Preencha todos os campos obrigatórios', 'error', 'startProcessFeedback');
                return;
            }

            db.ref('processos').orderByChild('dtNumber').equalTo(dtNumber).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) throw new Error('Já existe um processo com este número de DT');

                    const newProcess = {
                        dtNumber,
                        vehicleType,
                        dockNumber,
                        status: 'pending',
                        createdBy: currentUser.uid,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        currentStep: null,
                        totalPauseTime: 0
                    };

                    getStepsOrder(vehicleType).forEach(step => {
                        newProcess[step] = { status: 'pending' };
                    });

                    const processRef = db.ref('processos').push();
                    return processRef.set(newProcess)
                        .then(() => {
                            showFeedback('Processo criado com sucesso!', 'success', 'startProcessFeedback');
                            setTimeout(() => {
                                elements.startProcessModal.style.display = 'none';
                                elements.dtNumber.value = '';
                                elements.vehicleType.value = '';
                                elements.dockNumber.value = '';
                            }, 1500);
                        });
                })
                .catch(error => {
                    console.error('Erro ao iniciar processo:', error);
                    showFeedback('Erro: ' + error.message, 'error', 'startProcessFeedback');
                });
        }

        function confirmCurrentStep() {
            const action = elements.qrCodeModal.dataset.action;
            const processId = elements.qrCodeModal.dataset.processId;
            const step = elements.qrCodeModal.dataset.step;
            const isFinalStep = elements.qrCodeModal.dataset.isFinalStep === 'true';
            const operatorName = elements.qrCodeOperatorName.textContent;
            
            if (!operatorName || !processes[processId]) {
                showFeedback(operatorName ? 'Processo não encontrado' : 'Escaneie o QR Code do operador', 
                        'error', 'qrCodeFeedback');
                return;
            }
            
            elements.confirmQrCodeBtn.disabled = true;
            const processRef = db.ref(`processos/${processId}`);
            const process = processes[processId];
            const stepsOrder = getStepsOrder(process.vehicleType);
            const now = firebase.database.ServerValue.TIMESTAMP;
            
            const updates = {};
            
            if (action === 'start') {
                updates[`${step}/status`] = 'in_progress';
                updates[`${step}/startTime`] = now;
                updates[`${step}/operator`] = operatorName;
                updates.currentStep = step;
                updates.status = 'in_progress';
                
                if (!process.startTime) {
                    updates.startTime = now;
                }
                
                const currentIndex = stepsOrder.indexOf(step);
                if (currentIndex > 0) {
                    const prevStep = stepsOrder[currentIndex - 1];
                    if (process[prevStep]?.endTime) {
                        updates[`${step}/waitTime`] = (Date.now() - process[prevStep].endTime) / 1000;
                    }
                }
            } else {
                updates[`${step}/status`] = 'completed';
                updates[`${step}/endTime`] = now;
                
                if (process[step]?.startTime) {
                    updates[`${step}/duration`] = (Date.now() - process[step].startTime) / 1000;
                }
                
                const currentIndex = stepsOrder.indexOf(step);
                const nextStep = stepsOrder[currentIndex + 1];
                
                if (nextStep) {
                    updates[`${nextStep}/status`] = 'pending';
                    updates.currentStep = nextStep;
                } else {
                    updates.status = 'completed';
                    updates.endTime = now;
                }
            }
            
            processRef.update(updates)
                .then(() => {
                    showFeedback('Operação confirmada com sucesso!', 'success', 'qrCodeFeedback');
                    setTimeout(() => {
                        elements.qrCodeModal.style.display = 'none';
                        if (action === 'complete' && !updates.currentStep) {
                            saveProcessToHistory(processId);
                        }
                    }, 1500);
                })
                .catch(error => {
                    console.error('Erro ao confirmar etapa:', error);
                    showFeedback('Erro: ' + error.message, 'error', 'qrCodeFeedback');
                    elements.confirmQrCodeBtn.disabled = false;
                });
        }

        function getStepsOrder(vehicleType) {
            return ['vistoria', 'abertura', 'fechamento'];
        }

        function confirmAssistants() {
            const processId = elements.assistantsModal.dataset.processId;
            const step = elements.assistantsModal.dataset.step;
            const isInitialStep = elements.assistantsModal.dataset.isInitialStep === 'true';
            
            if (currentAssistants.length === 0 || !processes[processId]) {
                showFeedback(currentAssistants.length === 0 ? 'Adicione pelo menos um ajudante' : 'Processo não encontrado', 
                           'error', 'assistantsFeedback');
                return;
            }
            
            const processRef = db.ref(`processos/${processId}`);
            const updates = {};
            const assistantsList = currentAssistants.map(a => ({ code: a.code, name: a.name }));
            const now = firebase.database.ServerValue.TIMESTAMP;
            
            if (isInitialStep) {
                updates[`${step}/status`] = 'in_progress';
                updates[`${step}/startTime`] = now;
                updates[`${step}/assistants`] = assistantsList;
                updates.currentStep = step;
                updates.status = 'in_progress';
                if (!processes[processId].startTime) updates.startTime = now;
            } else {
                updates[`${step}/assistants`] = firebase.database.ServerValue.increment(assistantsList);
            }
            
            processRef.update(updates)
                .then(() => {
                    showFeedback('Ajudantes registrados com sucesso!', 'success', 'assistantsFeedback');
                    setTimeout(() => {
                        elements.assistantsModal.style.display = 'none';
                        currentAssistants = [];
                    }, 1500);
                })
                .catch(error => {
                    console.error('Erro ao registrar ajudantes:', error);
                    showFeedback('Erro: ' + error.message, 'error', 'assistantsFeedback');
                });
        }

        function saveProcessToHistory(processId) {
            if (!processes[processId]) return;
            
            const process = processes[processId];
            const historyData = {
                processId: process.id,
                dtNumber: process.dtNumber,
                vehicleType: process.vehicleType,
                dockNumber: process.dockNumber,
                startTime: process.startTime,
                endTime: process.endTime || firebase.database.ServerValue.TIMESTAMP,
                createdBy: process.createdBy,
                totalPauseTime: process.totalPauseTime || 0,
                steps: {},
                totalDuration: (process.endTime || Date.now()) - process.startTime - ((process.totalPauseTime || 0) * 1000)
            };
            
            getStepsOrder(process.vehicleType).forEach(step => {
                if (process[step]) {
                    historyData.steps[step] = {
                        name: getStepName(step),
                        status: process[step].status,
                        startTime: process[step].startTime,
                        endTime: process[step].endTime,
                        duration: process[step].duration,
                        waitTime: process[step].waitTime,
                        operator: process[step].operator,
                        assistants: process[step].assistants
                    };
                }
            });
            
            db.ref('historico_processos').push(historyData)
                .then(() => db.ref(`processos/${processId}`).remove());
        }

        function cancelProcess(processId) {
            if (confirm('Tem certeza que deseja cancelar este processo?')) {
                db.ref(`processos/${processId}`).remove()
                    .catch(error => {
                        console.error('Erro ao cancelar processo:', error);
                        showFeedback('Erro ao cancelar processo: ' + error.message, 'error', 'qrCodeFeedback');
                    });
            }
        }

        // Funções auxiliares
        function getStepName(stepId) {
            const stepNames = {
                'vistoria': 'Vistoria',
                'abertura': 'Abertura do Caminhão',
                'fechamento': 'Fechamento do Caminhão'
            };
            return stepNames[stepId] || stepId;
        }

        function getProcessTypeLabel(type) {
            const labels = {
                'carregamento': 'Carregamento'
            };
            return labels[type] || type;
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendente',
                'in_progress': 'Em Andamento',
                'paused': 'Pausado',
                'completed': 'Concluído'
            };
            return labels[status] || status;
        }

        function showFeedback(message, type, elementId) {
            const feedbackElement = document.getElementById(elementId);
            if (!feedbackElement) return;

            feedbackElement.textContent = message;
            feedbackElement.style.display = 'block';
            feedbackElement.className = `feedback ${type}`;
            
            if (type !== 'info') {
                setTimeout(() => feedbackElement.style.display = 'none', 5000);
            }
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>